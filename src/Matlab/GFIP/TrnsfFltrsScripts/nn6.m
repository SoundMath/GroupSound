function [y1,y2,y3,y6]=kk6(x,gp)
% n must be a multiple of 3. 
% indexing of x is [1 k^3;k^2 k^5;k^4 k]
[n3,tem]=size(x);
n=n3/3;
n2=n+n;
nd2=n/2;
nd3=n/3;
%
if (gp==1) % [0 1; -1 1]
   d1=1;
   c1(1,1)=1;
   c1(2,1)=1;
   d2=2;
   c2(1,1)=nd3+1;
   c2(2,1)=2*nd3+1;
   c2(1,2)=2*nd3+1;
   c2(2,2)=nd3+1;
   d3=3;
   c3(1,1)=1;
   c3(2,1)=nd2+1;
   c3(1,2)=nd2+1;
   c3(2,2)=1;
   c3(1,3)=nd2+1;
   c3(2,3)=nd2+1;
end   
%
if (gp==2) % [0 -1; 1 1]
   d1=1;
   c1(1,1)=1;
   c1(2,1)=1;
   d2=2;
   c2(1,1)=nd3+1;
   c2(2,1)=nd3+1;
   c2(1,2)=2*nd3+1;
   c2(2,2)=2*nd3+1;
   d3=3;
   c3(1,1)=1;
   c3(2,1)=nd2+1;
   c3(1,2)=nd2+1;
   c3(2,2)=1;
   c3(1,3)=nd2+1;
   c3(2,3)=nd2+1;
end   
%
if (gp==3 & rem(n/3,4)==0) % [-1 n/3+1;n/3-1 n/3]
   d1=3;
   c1(1,1)=1;
   c1(2,1)=1;
   c1(1,2)=nd3+1;
   c1(2,2)=nd3+1;
   c1(1,3)=2*nd3+1;
   c1(2,3)=2*nd3+1;
   d2=6;
   c2(1,1)=1;
   c2(2,1)=nd3+1;
   c2(1,2)=1;
   c2(2,2)=2*nd3+1;
   c2(1,3)=nd3+1;
   c2(2,3)=1;
   c2(1,4)=nd3+1;
   c2(2,4)=2*nd3+1;
   c2(1,5)=2*nd3+1;
   c2(2,5)=1;
   c2(1,6)=2*nd3+1;
   c2(2,6)=nd3+1;
   d3=n*nd3;
   for k1=0:n-1
      kk=rem(k1,3);
      for k2=0:nd3-1
         c3(1,1+k2+nd3*k1)=1+k1;
         c3(2,1+k2+nd3*k1)=1+kk+3*k2;
      end   
   end   
end   
if (gp==3 & rem(n/3,4)==2) % [-1 n/3+1;n/3-1 n/3]
   d1=1;
   c1(1,1)=1;
   c1(2,1)=1;
   d2=2;
   c2(1,1)=1;
   c2(2,1)=nd3;
   c2(1,2)=1;
   c2(2,2)=2*nd3+1;
   d3=nd3*nd3;
   for k1=0:nd3-1
      for k2=0:nd3-1
         c3(1,1+k2+nd3*k1)=1+3*k1;
         c3(2,1+k2+nd3*k1)=1+3*k2;
      end   
   end   
end   
%
if (gp==4 & rem(n/3,4)==0) % [n/2-1 n/3-1;n/3+1 n/3];
   d1=3;
   c1(1,1)=1;
   c1(2,1)=1;
   c1(1,2)=1;
   c1(2,2)=nd3+1;
   c1(1,3)=1;
   c1(2,3)=2*nd3+1;
   d2=6;
   c2(1,1)=nd3+1;
   c2(2,1)=1;
   c2(1,2)=nd3+1;
   c2(2,2)=nd3+1;
   c2(1,3)=nd3+1;
   c2(2,3)=2*nd3+1;
   c2(1,4)=2*nd3+1;
   c2(2,4)=1;
   c2(1,5)=2*nd3+1;
   c2(2,5)=nd3+1;
   c2(1,6)=2*nd3+1;
   c2(2,6)=2*nd3+1;
   d3=n*n/12;
   for k1=0:n/6-1
      for k2=0:n/2-1
         c3(1,1+k2+(n/2)*k1)=6*k1+1;
         c3(2,1+k2+(n/2)*k1)=2*k2+1;
      end
   end   
end
if (gp==4 & rem(n/3,4)==0) % [n/2-1 n/3-1;n/3+1 n/3];
   d1=1;
   c1(1,1)=1;
   c1(2,1)=1;
   d2=2;
   c2(1,1)=nd3+1;
   c2(2,1)=1;
   c2(1,2)=2*nd3+1;
   c2(2,2)=1;
   d3=(n/6)*(n/6)
   for k1=0:n/6-1
      for k2=0:n/6-1
         c3(1,1+k2+(n/6)*k1)=6*k1+1;
         c3(2,1+k2+(n/6)*k1)=6*k2+1;
      end
   end   
end
%
%
%
x(1:n,1:n)=n*ifft2(x(1:n,1:n));
x(1+n:n2,1:n)=n*ifft2(x(1+n:n2,1:n));
x(1+n2:n3,1:n)=n*ifft2(x(1+n2:n3,1:n));
x(1:n,1+n:n2)=n*ifft2(x(1:n,1+n:n2));
x(1+n:n2,1+n:n2)=n*ifft2(x(1+n:n2,1+n:n2));
x(1+n2:n3,1+n:n2)=n*ifft2(x(1+n2:n3,1+n:n2));
bf=x;
%
y1=zeros(n3,n2);
y2=zeros(n3,n2);
y3=zeros(n3,n2);
y6=zeros(n3,n2);
for k=1:d3
   t3(1,k)=x(c3(1,k),c3(2,k));
   t3(2,k)=x(c3(1,k),c3(2,k)+n);
   s3(1,k)=x(c3(1,k)+n,c3(2,k));
   s3(2,k)=x(c3(1,k)+n,c3(2,k)+n);
   r3(1,k)=x(c3(1,k)+n2,c3(2,k));
   r3(2,k)=x(c3(1,k)+n2,c3(2,k)+n);
end
t3=sqrt(2)*ifft(t3);
s3=sqrt(2)*ifft(s3);
r3=sqrt(2)*ifft(r3);
for k=1:d3
   bf(c3(1,k),c3(2,k))=t3(1,k);
   bf(c3(1,k),c3(2,k)+n)=t3(2,k);
   bf(c3(1,k)+n,c3(2,k))=s3(1,k);
   bf(c3(1,k)+n,c3(2,k)+n)=s3(2,k);
   bf(c3(1,k)+n2,c3(2,k))=r3(1,k);
   bf(c3(1,k)+n2,c3(2,k)+n)=r3(2,k);
   y3(c3(1,k),c3(2,k))=t3(1,k);
   y3(c3(1,k),c3(2,k)+n)=t3(2,k);
   y3(c3(1,k)+n,c3(2,k))=s3(1,k);
   y3(c3(1,k)+n,c3(2,k)+n)=s3(2,k);
   y3(c3(1,k)+n2,c3(2,k))=r3(1,k);
   y3(c3(1,k)+n2,c3(2,k)+n)=r3(2,k);
end
for k=1:d2
   t2(1,k)=x(c2(1,k),c2(2,k));
   t2(2,k)=x(c2(1,k)+n,c2(2,k));
   t2(3,k)=x(c2(1,k)+n2,c2(2,k));
   s2(1,k)=x(c2(1,k),c2(2,k)+n);
   s2(2,k)=x(c2(1,k)+n,c2(2,k)+n);
   s2(3,k)=x(c2(1,k)+n2,c2(2,k)+n);
end   
t2=sqrt(3)*ifft(t2);
s2=sqrt(3)*ifft(s2);
for k=1:d2
   k1=c2(1,k);
   k2=c2(2,k);
   bf(k1,k2)=t2(1,k);
   bf(k1+n,k2)=t2(2,k);
   bf(k1+n2,k2)=t2(3,k);
   bf(k1,k2+n)=s2(1,k);
   bf(k1+n,k2+n)=s2(2,k);
   bf(k1+n2,k2+n)=s2(3,k);
   y2(k1,k2)=t2(1,k);
   y2(k1+n,k2)=t2(2,k);
   y2(k1+n2,k2)=t2(3,k);
   y2(k1,k2+n)=s2(1,k);
   y2(k1+n,k2+n)=s2(2,k);
   y2(k1+n2,k2+n)=s2(3,k);
   y3(k1,k2)=0;
   y3(k1+n,k2)=0;
   y3(k1+n2,k2)=0;
   y3(k1,k2+n)=0;
   y3(k1+n,k2+n)=0;
   y3(k1+n2,k2+n)=0;
end
for k=1:d1
   t1(1,k)=x(c1(1,k),c1(2,k));
   t1(2,k)=x(c1(1,k)+n,c1(2,k));
   t1(3,k)=x(c1(1,k)+n2,c1(2,k));
   t1(4,k)=x(c1(1,k),c1(2,k)+n);
   t1(5,k)=x(c1(1,k)+n,c1(2,k)+n);
   t1(6,k)=x(c1(1,k)+n2,c1(2,k)+n);
end   
t1=sqrt(6)*ifft(t1);
for k=1:d1
   bf(c1(1,k),c1(2,k))=t1(1,k);
   bf(c1(1,k)+n,c1(2,k))=t1(2,k);
   bf(c1(1,k)+n2,c1(2,k))=t1(3,k);
   bf(c1(1,k),c1(2,k)+n)=t1(4,k);
   bf(c1(1,k)+n,c1(2,k)+n)=t1(5,k);
   bf(c1(1,k)+n2,c1(2,k)+n)=t1(6,k);
   y1(c1(1,k),c1(2,k))=t1(1,k);
   y1(c1(1,k)+n,c1(2,k))=t1(2,k);
   y1(c1(1,k)+n2,c1(2,k))=t1(3,k);
   y1(c1(1,k),c1(2,k)+n)=t1(4,k);
   y1(c1(1,k)+n,c1(2,k)+n)=t1(5,k);
   y1(c1(1,k)+n2,c1(2,k)+n)=t1(6,k);
   y2(c1(1,k),c1(2,k))=0;
   y2(c1(1,k)+n,c1(2,k))=0;
   y2(c1(1,k)+n2,c1(2,k))=0;
   y2(c1(1,k),c1(2,k)+n)=0;
   y2(c1(1,k)+n,c1(2,k)+n)=0;
   y2(c1(1,k)+n2,c1(2,k)+n)=0;
   y3(c1(1,k),c1(2,k))=0;
   y3(c1(1,k)+n,c1(2,k))=0;
   y3(c1(1,k)+n2,c1(2,k))=0;
   y3(c1(1,k),c1(2,k)+n)=0;
   y3(c1(1,k)+n,c1(2,k)+n)=0;
   y3(c1(1,k)+n2,c1(2,k)+n)=0;
end   
y6=bf-y1-y2-y3;
